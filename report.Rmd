---
title: "European Value Study (EVS)"
author: "Sungjoo Cho"
date: "`r Sys.Date()`"
output: html_document
params:
  country: "overall"
  outcome: "child_suffer"
  controls: c("sex")
  polynomial: 1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
# Libaray
library(broom)
library(shiny)
library(tidyverse)
library(ggplot2)
library(plotly)
library(shinydashboard)
library(haven)
library(DT) 
library(knitr)
library(texreg)
```


# `r params$country` Report

##### Description of the Application

This report was generated by the application designed to analyze data sourced from the European Value Study (EVS). Through the app, users can explore attitudes towards gender roles and immigration. Analysis of the overall data with the entire sample, as well as on a country-by-country basis, is available by using the country drop-down menu located in the sidebar. 


## Introduction

This report explores attitudes towards gender roles and immigration using `r params$country` data from [2017 European Value Study (EVS)](https://search.gesis.org/research_data/ZA7500). Key variables analyzed include v72 and v80, which respectively measure perceptions on maternal employment effects and job priority during scarcity.

-   **v72** - Child suffers with working mother
    -   Question: When a mother works for pay, the children suffer
    -   Scale: 1 (Strongly agree) to 4 (Strongly disagree)
-   **v80** - Jobs are scarce:giving...(nation)priority
    -   Question: When jobs are scarce, employers should give priority to [Nationality] people over immigrants"
    -   Scale: 1 (Strongly agree) to 4 (Strongly disagree)


## Exploration

Below is the graph for `r params$output` and the three controls: age, education, and sex, using the EVS `r params$country` data.

```{r message=FALSE, warning=FALSE, include=FALSE}
# import data
evs <- readRDS("data/evs.rds")

data <- evs
if (params$country != "overall") {
  data <- evs[evs$cntry == params$country, ]
}
```

```{r message=FALSE, warning=FALSE, include=FALSE}
ExplorationPlot <- function(data, y_var){
  
  # filter data
  data <- data %>%
    na.omit()
  
  # plot
  plot <- data %>%
    ggplot(aes(x = age, y = !!as.name(y_var), color = interaction(edu, sex))) +  
    stat_summary(geom = "line", fun = "mean") +
    labs(title = "Average disagreement of job_national by age",
         x = "Age",
         y = "Average Disagreement") 
  
  ggplotly(plot)
}
```

```{r echo=FALSE}
ExplorationPlot(data, params$outcome)
```


## Regression

### Regression Model

The table presented below shows the regression coefficients for the '`r params$outcome`' outcome variable.

```{r echo=FALSE}
 # age and edu arguments
if ("sex" %in% params$controls) {
  s <- TRUE
} else {
  s <- FALSE
}
    
if ("edu" %in% params$controls) {
  e <- TRUE
} else {
  e <- FALSE
}


# 1. Regression model table
RegTable <- function(data, y_var, age_poly = 1, sex = FALSE, edu = FALSE) {
  
  data <- data %>%
    na.omit()
  
  # regression formula
  reg_formula <- paste0(y_var, " ~ poly(age, ", age_poly, ", raw =TRUE)")
  
  if (sex) {
    reg_formula <- paste0(reg_formula, " + sex")
  }
  
  if (edu) {
    reg_formula <- paste0(reg_formula, " + edu")
  }
  
  # regression model
  reg_model <- lm(reg_formula, data = data)
  reg_model_table <- as.data.frame((tidy(reg_model)))
  datatable(reg_model_table)
}
```

```{r echo=FALSE}
RegTable(data, params$outcome, params$polynomial, s, e)
```

Based on the regression model, it appears that as age increases, people are

### Residual Plot

The plot presented below illustrates the predicted versus the residuals from the regression model for the `r params$outcome` outcome variable.

```{r include=FALSE}
# 2. Regression model scatter plot
RegScatterPlot <- function(data, y_var, age_poly = 1, sex = FALSE, edu = FALSE) {
  
  data <- data %>%
    na.omit()
  
  # regression formula
  reg_formula <- paste0(y_var, " ~ poly(age, ", age_poly, ", raw =TRUE)")
  
  if (sex) {
    reg_formula <- paste0(reg_formula, " + sex")
  }
  
  if (edu) {
    reg_formula <- paste0(reg_formula, " + edu")
  }
  
  # regression model
  reg_model <- lm(reg_formula, data = data)
  
  # Obtain the residuals and predicted values
  residuals <- residuals(reg_model)
  predicted <- fitted(reg_model)
  
  # Create a data frame with predicted and residuals
  plot_data <- data.frame(Predicted = predicted, Residuals = residuals)
  
  # Create a scatter plot using ggplot
  scatter_plot <- ggplot(plot_data, aes(x = Predicted, y = Residuals)) +
    geom_point() +
    labs(x = "Predicted Values", y = "Residuals",
         title = "Scatter Plot of Predicted vs. Residuals")
  
  ggplotly(scatter_plot)
}
```

```{r echo=FALSE}
RegScatterPlot(data, params$outcome, params$polynomial, s, e)
```

